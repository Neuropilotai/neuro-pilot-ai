// Prisma Schema for NeuroInnovate Inventory Enterprise
// This schema reflects the existing PostgreSQL database structure
// and adds new enterprise hardening models

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// EXISTING MODELS (from migrations 001-040)
// ============================================

// Organizations (from migration 023)
model Organization {
  id        String   @id @default(uuid()) @db.Uuid
  slug      String   @unique @db.VarChar(100)
  name      String   @db.VarChar(255)
  legalName String?  @map("legal_name") @db.VarChar(255)
  email     String   @db.VarChar(255)
  phone     String?  @db.VarChar(50)
  website   String?  @db.VarChar(255)
  
  // Address
  addressLine1 String? @map("address_line1") @db.VarChar(255)
  addressLine2 String? @map("address_line2") @db.VarChar(255)
  city         String? @db.VarChar(100)
  state        String? @db.VarChar(100)
  postalCode   String? @map("postal_code") @db.VarChar(20)
  country      String? @default("CA") @db.VarChar(2)
  
  // Billing
  stripeCustomerId    String? @map("stripe_customer_id") @unique @db.VarChar(100)
  stripeSubscriptionId String? @map("stripe_subscription_id") @db.VarChar(100)
  billingEmail        String? @map("billing_email") @db.VarChar(255)
  billingPlan         String? @map("billing_plan") @default("free") @db.VarChar(50)
  billingStatus       String? @map("billing_status") @default("active") @db.VarChar(50)
  trialEndsAt          DateTime? @map("trial_ends_at") @db.Timestamptz
  
  // Limits
  maxUsers          Int?     @map("max_users") @default(3)
  maxItems          Int?     @map("max_items") @default(500)
  maxLocations      Int?     @map("max_locations") @default(5)
  maxApiCallsPerDay Int?     @map("max_api_calls_per_day") @default(1000)
  features          Json?    @default("{}")
  
  // Settings
  timezone        String?  @default("America/Toronto") @db.VarChar(50)
  currency        String?  @default("CAD") @db.VarChar(3)
  fiscalYearStart Int?     @map("fiscal_year_start") @default(1)
  settings        Json?    @default("{}")
  
  // Security
  ssoEnabled  Boolean? @map("sso_enabled") @default(false)
  ssoProvider String? @map("sso_provider") @db.VarChar(50)
  ssoConfig   Json?    @map("sso_config")
  mfaRequired Boolean? @map("mfa_required") @default(false)
  ipAllowlist String[] @map("ip_allowlist")
  
  // Audit
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  createdBy String?   @map("created_by") @db.Uuid
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz
  updatedBy String?   @map("updated_by") @db.Uuid
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz
  
  // Relations
  inventoryBalances InventoryBalance[]
  
  @@index([slug])
  @@index([stripeCustomerId])
  @@index([billingStatus])
  @@map("organizations")
}

// Inventory Items (from migration 015)
model InventoryItem {
  itemId        Int      @id @default(autoincrement()) @map("item_id")
  itemCode      String   @unique @map("item_code") @db.Text
  itemName      String   @map("item_name") @db.Text
  description   String?  @db.Text
  unit          String   @default("EA") @db.Text
  category      String?  @db.Text
  costCode      String?  @map("cost_code") @db.Text
  parLevel      Float?   @map("par_level") @default(0)
  reorderPoint  Float?   @map("reorder_point") @default(0)
  currentQuantity Float? @map("current_quantity") @default(0)
  lastCountDate DateTime? @map("last_count_date") @db.Date
  lastInvoiceDate DateTime? @map("last_invoice_date") @db.Date
  lastInvoiceNo String? @map("last_invoice_no") @db.Text
  isActive      Int      @map("is_active") @default(1)
  barcode       String?  @db.Text
  notes         String?  @db.Text
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamp
  
  inventoryBalances InventoryBalance[]
  
  @@index([itemCode])
  @@index([category])
  @@index([isActive])
  @@map("inventory_items")
}

// Item Locations (from migration 015)
model ItemLocation {
  locationId   Int      @id @default(autoincrement()) @map("location_id")
  locationCode String  @unique @map("location_code") @db.Text
  locationName String  @map("location_name") @db.Text
  locationType String  @map("location_type") @default("STORAGE") @db.Text
  sequence     Int      @default(0)
  isActive     Int      @map("is_active") @default(1)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp
  
  inventoryBalances InventoryBalance[]
  
  @@index([locationType])
  @@map("item_locations")
}

// ============================================
// NEW ENTERPRISE MODELS
// ============================================

// Materialized Inventory Balance Table
// Provides fast balance queries (10x+ faster than ledger SUM)
model InventoryBalance {
  id          String   @id @default(uuid()) @db.Uuid
  orgId       String   @map("org_id") @db.Uuid
  itemId      Int      @map("item_id")
  locationId  Int      @map("location_id")
  lotId       String?  @map("lot_id") @db.Uuid
  qtyCanonical Decimal  @map("qty_canonical") @db.Decimal(18, 6)
  lastUpdated DateTime @default(now()) @map("last_updated") @db.Timestamptz
  lastLedgerId String? @map("last_ledger_id") @db.Uuid
  
  org      Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  item    InventoryItem  @relation(fields: [itemId], references: [itemId])
  location ItemLocation  @relation(fields: [locationId], references: [locationId])
  
  @@unique([orgId, itemId, locationId, lotId])
  @@index([orgId, itemId, locationId])
  @@index([orgId, itemId])
  @@index([lastUpdated])
  @@map("inventory_balances")
}

