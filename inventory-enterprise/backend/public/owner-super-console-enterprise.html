<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NeuroInnovate â€” Enterprise Console V21</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸ§ </text></svg>">

  <!-- Tailwind CSS JIT -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Day.js for dates -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>

  <!-- Tabler Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">

  <!-- Production Bootstrap - Live API Only -->
  <script>
    (function bootstrapNPConfig() {
      try {
        const PRESET_API = 'https://inventory-backend-7-agent-build.up.railway.app';
        if (!localStorage.getItem('NP_API_URL')) {
          localStorage.setItem('NP_API_URL', PRESET_API);
        }
        // Force real data only - no mock mode
        localStorage.setItem('NP_MOCK_MODE', 'false');
      } catch (e) {
        console.warn('Bootstrap failed:', e);
      }
    })();
  </script>

  <style>
    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    .dark ::-webkit-scrollbar-track { background: #1e293b; }
    .dark ::-webkit-scrollbar-thumb { background: #475569; }
    .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }

    /* Skeleton loading */
    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }
    .skeleton {
      animation: shimmer 2s infinite;
      background: linear-gradient(to right, #f1f5f9 4%, #e2e8f0 25%, #f1f5f9 36%);
      background-size: 1000px 100%;
    }
    .dark .skeleton {
      background: linear-gradient(to right, #334155 4%, #475569 25%, #334155 36%);
    }

    /* Glassy card effect */
    .glass-card {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .dark .glass-card {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(71, 85, 105, 0.2);
    }

    /* Sticky header */
    .sticky-header {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    /* Badge pulse */
    @keyframes pulse-badge {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    .badge-pulse {
      animation: pulse-badge 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
  </style>
</head>
<body class="h-full bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 transition-colors">

  <!-- Login Screen -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md">
      <div class="glass-card rounded-3xl shadow-2xl p-8">
        <div class="text-center mb-8">
          <div class="text-6xl mb-4">ðŸ§ </div>
          <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">NeuroInnovate</h1>
          <p class="text-slate-600 dark:text-slate-400">Enterprise Console V21.0</p>
        </div>

        <form id="loginForm" class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Email</label>
            <input type="email" id="emailInput" class="w-full px-4 py-3 rounded-xl bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="owner@company.com" required>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Password</label>
            <input type="password" id="passwordInput" class="w-full px-4 py-3 rounded-xl bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
          </div>

          <button type="submit" class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl transition-all shadow-lg hover:shadow-xl transform hover:scale-105">
            Sign In
          </button>

          <div class="text-xs text-slate-500 dark:text-slate-400 text-center">
            Test: admin@local / owner@local / staff@local<br>Password: (any)
          </div>
        </form>

        <div id="loginError" class="mt-4 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl text-red-700 dark:text-red-400 text-sm hidden"></div>
      </div>
    </div>
  </div>

  <!-- Main Application -->
  <div id="mainApp" class="hidden h-full flex flex-col">
    <!-- Top Bar -->
    <header class="sticky-header glass-card border-b border-slate-200 dark:border-slate-700 px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <button id="menuToggle" class="lg:hidden p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl">
            <i class="ti ti-menu-2 text-xl"></i>
          </button>
          <div>
            <h1 class="text-xl font-bold text-slate-900 dark:text-white">ðŸ§  NeuroInnovate</h1>
            <p class="text-xs text-slate-500 dark:text-slate-400">Enterprise V21.0</p>
          </div>
        </div>

        <div class="flex items-center space-x-4">
          <button id="refreshBtn" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl transition-all" title="Refresh data">
            <i class="ti ti-refresh text-xl text-slate-600 dark:text-slate-400"></i>
          </button>

          <button id="themeToggle" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl transition-all">
            <i class="ti ti-moon text-xl text-slate-600 dark:text-slate-400"></i>
          </button>

          <div class="flex items-center space-x-3 border-l border-slate-300 dark:border-slate-600 pl-4">
            <div class="text-right">
              <p id="userDisplay" class="text-sm font-medium text-slate-900 dark:text-white">-</p>
              <p id="roleDisplay" class="text-xs text-slate-500 dark:text-slate-400">-</p>
            </div>
            <button id="logoutBtn" class="p-2 hover:bg-red-100 dark:hover:bg-red-900/20 text-red-600 dark:text-red-400 rounded-xl transition-all">
              <i class="ti ti-logout text-xl"></i>
            </button>
          </div>
        </div>
      </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
      <!-- Sidebar -->
      <aside id="sidebar" class="w-64 glass-card border-r border-slate-200 dark:border-slate-700 overflow-y-auto">
        <nav class="p-3 space-y-1">
          <a href="#dashboard" class="nav-link active group flex items-center space-x-3 px-3 py-2.5 rounded-xl text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 transition-all">
            <i class="ti ti-dashboard text-lg"></i>
            <span>Dashboard</span>
          </a>

          <a href="#items" class="nav-link group flex items-center space-x-3 px-3 py-2.5 rounded-xl text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 transition-all">
            <i class="ti ti-box text-lg"></i>
            <span>Items</span>
          </a>

          <a href="#inventory" class="nav-link group flex items-center space-x-3 px-3 py-2.5 rounded-xl text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 transition-all">
            <i class="ti ti-clipboard-list text-lg"></i>
            <span>Inventory</span>
          </a>

          <!-- V21 Enterprise Features -->
          <div class="pt-3 pb-2 mt-3 border-t border-slate-200 dark:border-slate-700">
            <p class="text-xs font-semibold text-slate-500 dark:text-slate-400 mb-2 px-3">ðŸš€ V21 Enterprise</p>
          </div>

          <a href="#vendors" class="nav-link group flex items-center space-x-3 px-3 py-2.5 rounded-xl text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 transition-all">
            <i class="ti ti-building-store text-lg"></i>
            <span>Vendors & Pricing</span>
          </a>

          <a href="#recipes" class="nav-link group flex items-center space-x-3 px-3 py-2.5 rounded-xl text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 transition-all">
            <i class="ti ti-chef-hat text-lg"></i>
            <span>Recipes</span>
          </a>

          <a href="#menu" class="nav-link group flex items-center space-x-3 px-3 py-2.5 rounded-xl text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 transition-all">
            <i class="ti ti-calendar-event text-lg"></i>
            <span>Menu Planning</span>
          </a>

          <a href="#population" class="nav-link group flex items-center space-x-3 px-3 py-2.5 rounded-xl text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 transition-all">
            <i class="ti ti-users text-lg"></i>
            <span>Population</span>
          </a>

          <a href="#waste" class="nav-link group flex items-center space-x-3 px-3 py-2.5 rounded-xl text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 transition-all">
            <i class="ti ti-trash text-lg"></i>
            <span>Waste Tracking</span>
          </a>

          <a href="#pdfs" class="nav-link group flex items-center space-x-3 px-3 py-2.5 rounded-xl text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 transition-all">
            <i class="ti ti-file-download text-lg"></i>
            <span>PDF Reports</span>
          </a>
        </nav>
      </aside>

      <!-- Main Content Area -->
      <main class="flex-1 overflow-y-auto p-6">
        <!-- Dashboard Section -->
        <div id="dashboardSection" class="section">
          <div class="mb-6">
            <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">Dashboard</h2>
            <p class="text-slate-600 dark:text-slate-400">Executive overview of your operations</p>
          </div>

          <!-- Stats Cards -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="glass-card rounded-2xl p-6 shadow-lg border border-slate-200 dark:border-slate-700">
              <div class="flex items-center justify-between mb-4">
                <div class="bg-blue-100 dark:bg-blue-900/30 p-3 rounded-xl">
                  <i class="ti ti-package text-2xl text-blue-600 dark:text-blue-400"></i>
                </div>
              </div>
              <p class="text-sm text-slate-600 dark:text-slate-400 mb-1">Total Items</p>
              <p id="dashTotalItems" class="text-3xl font-bold text-slate-900 dark:text-white">-</p>
            </div>

            <div class="glass-card rounded-2xl p-6 shadow-lg border border-slate-200 dark:border-slate-700">
              <div class="flex items-center justify-between mb-4">
                <div class="bg-green-100 dark:bg-green-900/30 p-3 rounded-xl">
                  <i class="ti ti-stack text-2xl text-green-600 dark:text-green-400"></i>
                </div>
              </div>
              <p class="text-sm text-slate-600 dark:text-slate-400 mb-1">Total Quantity</p>
              <p id="dashTotalQty" class="text-3xl font-bold text-slate-900 dark:text-white">-</p>
            </div>

            <div class="glass-card rounded-2xl p-6 shadow-lg border border-slate-200 dark:border-slate-700">
              <div class="flex items-center justify-between mb-4">
                <div class="bg-purple-100 dark:bg-purple-900/30 p-3 rounded-xl">
                  <i class="ti ti-map-pin text-2xl text-purple-600 dark:text-purple-400"></i>
                </div>
              </div>
              <p class="text-sm text-slate-600 dark:text-slate-400 mb-1">Locations</p>
              <p id="dashLocations" class="text-3xl font-bold text-slate-900 dark:text-white">-</p>
            </div>

            <div class="glass-card rounded-2xl p-6 shadow-lg border border-slate-200 dark:border-slate-700">
              <div class="flex items-center justify-between mb-4">
                <div class="bg-orange-100 dark:bg-orange-900/30 p-3 rounded-xl">
                  <i class="ti ti-alert-triangle text-2xl text-orange-600 dark:text-orange-400"></i>
                </div>
              </div>
              <p class="text-sm text-slate-600 dark:text-slate-400 mb-1">Low Stock</p>
              <p id="dashLowStock" class="text-3xl font-bold text-slate-900 dark:text-white">-</p>
            </div>
          </div>

          <!-- Charts -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="glass-card rounded-2xl p-6 shadow-lg border border-slate-200 dark:border-slate-700">
              <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Inventory by Category</h3>
              <canvas id="categoryChart" height="250"></canvas>
            </div>

            <div class="glass-card rounded-2xl p-6 shadow-lg border border-slate-200 dark:border-slate-700">
              <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Inventory Trend</h3>
              <canvas id="trendChart" height="250"></canvas>
            </div>
          </div>
        </div>

        <!-- Items Section -->
        <div id="itemsSection" class="section hidden">
          <div class="mb-6 flex items-center justify-between">
            <div>
              <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">Items</h2>
              <p class="text-slate-600 dark:text-slate-400">Manage your product catalog</p>
            </div>
            <button id="addItemBtn" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-lg transition-all">
              <i class="ti ti-plus mr-2"></i>Add Item
            </button>
          </div>

          <!-- Search & Filter -->
          <div class="mb-6 glass-card rounded-2xl p-4 border border-slate-200 dark:border-slate-700">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <input type="text" id="itemSearchInput" placeholder="Search items..." class="px-4 py-2 rounded-xl bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white">

              <select id="itemCategoryFilter" class="px-4 py-2 rounded-xl bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white">
                <option value="">All Categories</option>
              </select>

              <button id="itemRefreshBtn" class="px-4 py-2 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 rounded-xl transition-all">
                <i class="ti ti-refresh mr-2"></i>Refresh
              </button>
            </div>
          </div>

          <!-- Items Table -->
          <div class="glass-card rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-100 dark:bg-slate-800">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">SKU</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Category</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">UOM</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Par Level</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Status</th>
                  </tr>
                </thead>
                <tbody id="itemsTableBody" class="divide-y divide-slate-200 dark:divide-slate-700 bg-white dark:bg-slate-900">
                  <tr>
                    <td colspan="6" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400">Loading items...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Inventory Section -->
        <div id="inventorySection" class="section hidden">
          <div class="mb-6 flex items-center justify-between">
            <div>
              <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">Inventory</h2>
              <p class="text-slate-600 dark:text-slate-400">Real-time stock levels across locations</p>
            </div>
            <button id="importInventoryBtn" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-xl shadow-lg transition-all">
              <i class="ti ti-upload mr-2"></i>Import CSV
            </button>
          </div>

          <!-- Inventory Table -->
          <div class="glass-card rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-100 dark:bg-slate-800">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">SKU</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Item Name</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Location</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Quantity</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Lot</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Last Count</th>
                  </tr>
                </thead>
                <tbody id="inventoryTableBody" class="divide-y divide-slate-200 dark:divide-slate-700 bg-white dark:bg-slate-900">
                  <tr>
                    <td colspan="6" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400">Loading inventory...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Vendors & Pricing Section -->
        <div id="vendorsSection" class="section hidden">
          <div class="mb-6 flex items-center justify-between">
            <div>
              <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">Vendors & Pricing</h2>
              <p class="text-slate-600 dark:text-slate-400">Manage vendor pricing with effective dating</p>
            </div>
            <button id="importVendorPricesBtn" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-lg transition-all">
              <i class="ti ti-upload mr-2"></i>Import CSV Prices
            </button>
          </div>

          <!-- Vendor Preference -->
          <div class="mb-6 glass-card rounded-2xl p-6 border border-slate-200 dark:border-slate-700">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Preferred Vendor</h3>
            <div class="flex items-center space-x-4">
              <select id="preferredVendorSelect" class="flex-1 px-4 py-2 rounded-xl bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white">
                <option value="">Loading vendors...</option>
              </select>
              <button id="savePreferredVendorBtn" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-xl transition-all">
                Save Preference
              </button>
            </div>
            <p class="text-xs text-slate-500 dark:text-slate-400 mt-2">Used for recipe costing with fallback to any vendor</p>
          </div>

          <!-- Price Lookup Tool -->
          <div class="mb-6 glass-card rounded-2xl p-6 border border-slate-200 dark:border-slate-700">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Price Lookup</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <input type="text" id="priceLookupSKU" placeholder="Item SKU" class="px-4 py-2 rounded-xl bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white">
              <input type="date" id="priceLookupDate" class="px-4 py-2 rounded-xl bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white">
              <button id="lookupPriceBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl transition-all">
                <i class="ti ti-search mr-2"></i>Lookup Price
              </button>
            </div>
            <div id="priceLookupResult" class="mt-4 hidden p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-xl"></div>
          </div>

          <!-- Vendors Table -->
          <div class="glass-card rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-100 dark:bg-slate-800">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Vendor</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Contact</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Items</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Status</th>
                  </tr>
                </thead>
                <tbody id="vendorsTableBody" class="divide-y divide-slate-200 dark:divide-slate-700 bg-white dark:bg-slate-900">
                  <tr>
                    <td colspan="4" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400">Loading vendors...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Recipes Section -->
        <div id="recipesSection" class="section hidden">
          <div class="mb-6 flex items-center justify-between">
            <div>
              <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">Recipes</h2>
              <p class="text-slate-600 dark:text-slate-400">Recipe management with live costing</p>
            </div>
            <button id="addRecipeBtn" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-lg transition-all">
              <i class="ti ti-plus mr-2"></i>New Recipe
            </button>
          </div>

          <!-- Recipes Grid -->
          <div id="recipesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="glass-card rounded-2xl p-6 border border-slate-200 dark:border-slate-700">
              <p class="text-center text-slate-500 dark:text-slate-400">Loading recipes...</p>
            </div>
          </div>
        </div>

        <!-- Menu Planning Section -->
        <div id="menuSection" class="section hidden">
          <div class="mb-6 flex items-center justify-between">
            <div>
              <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">Menu Planning</h2>
              <p class="text-slate-600 dark:text-slate-400">4-week cycle with cost forecasting</p>
            </div>
            <div class="flex items-center space-x-4">
              <select id="menuWeekSelect" class="px-4 py-2 rounded-xl bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white">
                <option value="1">Week 1</option>
                <option value="2">Week 2</option>
                <option value="3">Week 3</option>
                <option value="4">Week 4</option>
              </select>
              <button id="forecastCostBtn" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-xl shadow-lg transition-all">
                <i class="ti ti-chart-line mr-2"></i>Forecast Cost
              </button>
            </div>
          </div>

          <!-- Menu Calendar -->
          <div class="glass-card rounded-2xl p-6 border border-slate-200 dark:border-slate-700">
            <div class="grid grid-cols-7 gap-4 mb-4">
              <div class="text-center font-semibold text-slate-700 dark:text-slate-300">Monday</div>
              <div class="text-center font-semibold text-slate-700 dark:text-slate-300">Tuesday</div>
              <div class="text-center font-semibold text-slate-700 dark:text-slate-300">Wednesday</div>
              <div class="text-center font-semibold text-slate-700 dark:text-slate-300">Thursday</div>
              <div class="text-center font-semibold text-slate-700 dark:text-slate-300">Friday</div>
              <div class="text-center font-semibold text-slate-700 dark:text-slate-300">Saturday</div>
              <div class="text-center font-semibold text-slate-700 dark:text-slate-300">Sunday</div>
            </div>
            <div id="menuCalendar" class="grid grid-cols-7 gap-4">
              <!-- Calendar populated by JS -->
            </div>
          </div>

          <!-- Cost Forecast Display -->
          <div id="costForecastDisplay" class="mt-6 hidden glass-card rounded-2xl p-6 border border-slate-200 dark:border-slate-700">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Week Cost Forecast</h3>
            <div id="costForecastContent"></div>
          </div>
        </div>

        <!-- Population Section -->
        <div id="populationSection" class="section hidden">
          <div class="mb-6 flex items-center justify-between">
            <div>
              <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">Population Management</h2>
              <p class="text-slate-600 dark:text-slate-400">Daily headcount for accurate forecasting</p>
            </div>
            <button id="addPopulationBtn" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-lg transition-all">
              <i class="ti ti-plus mr-2"></i>Add Daily Count
            </button>
          </div>

          <!-- Population Chart -->
          <div class="mb-6 glass-card rounded-2xl p-6 border border-slate-200 dark:border-slate-700">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Population Trend</h3>
            <canvas id="populationChart" height="300"></canvas>
          </div>

          <!-- Population Table -->
          <div class="glass-card rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-100 dark:bg-slate-800">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Date</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Population</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Notes</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody id="populationTableBody" class="divide-y divide-slate-200 dark:divide-slate-700 bg-white dark:bg-slate-900">
                  <tr>
                    <td colspan="4" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400">Loading population data...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Waste Tracking Section -->
        <div id="wasteSection" class="section hidden">
          <div class="mb-6 flex items-center justify-between">
            <div>
              <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">Waste Tracking</h2>
              <p class="text-slate-600 dark:text-slate-400">Capture waste with auto-cost calculation</p>
            </div>
            <button id="quickWasteBtn" class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-xl shadow-lg transition-all">
              <i class="ti ti-plus mr-2"></i>Quick Waste
            </button>
          </div>

          <!-- Waste Analytics -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="glass-card rounded-2xl p-6 border border-slate-200 dark:border-slate-700">
              <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Waste by Reason</h3>
              <canvas id="wasteReasonChart" height="250"></canvas>
            </div>

            <div class="glass-card rounded-2xl p-6 border border-slate-200 dark:border-slate-700">
              <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Waste Trend (30 days)</h3>
              <canvas id="wasteTrendChart" height="250"></canvas>
            </div>
          </div>

          <!-- Waste Events Table -->
          <div class="glass-card rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-100 dark:bg-slate-800">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Date</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Item/Recipe</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Quantity</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Reason</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">Cost</th>
                  </tr>
                </thead>
                <tbody id="wasteTableBody" class="divide-y divide-slate-200 dark:divide-slate-700 bg-white dark:bg-slate-900">
                  <tr>
                    <td colspan="5" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400">Loading waste events...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- PDF Reports Section -->
        <div id="pdfsSection" class="section hidden">
          <div class="mb-6">
            <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">PDF Reports</h2>
            <p class="text-slate-600 dark:text-slate-400">Generate professional reports and documents</p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Count Sheet PDF -->
            <div class="glass-card rounded-2xl p-6 border border-slate-200 dark:border-slate-700">
              <div class="flex items-center space-x-3 mb-4">
                <div class="bg-blue-100 dark:bg-blue-900/30 p-3 rounded-xl">
                  <i class="ti ti-clipboard text-2xl text-blue-600 dark:text-blue-400"></i>
                </div>
                <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Count Sheet</h3>
              </div>
              <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">Physical inventory count form</p>
              <div class="space-y-3">
                <input type="date" id="pdfCountDate" class="w-full px-4 py-2 rounded-xl bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white">
                <button onclick="APP.generatePDF('count')" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl transition-all">
                  <i class="ti ti-download mr-2"></i>Generate
                </button>
              </div>
            </div>

            <!-- Menu Pack PDF -->
            <div class="glass-card rounded-2xl p-6 border border-slate-200 dark:border-slate-700">
              <div class="flex items-center space-x-3 mb-4">
                <div class="bg-green-100 dark:bg-green-900/30 p-3 rounded-xl">
                  <i class="ti ti-chef-hat text-2xl text-green-600 dark:text-green-400"></i>
                </div>
                <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Menu Pack</h3>
              </div>
              <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">Weekly menu with recipes</p>
              <div class="space-y-3">
                <select id="pdfMenuWeek" class="w-full px-4 py-2 rounded-xl bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white">
                  <option value="1">Week 1</option>
                  <option value="2">Week 2</option>
                  <option value="3">Week 3</option>
                  <option value="4">Week 4</option>
                </select>
                <button onclick="APP.generatePDF('menu')" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-xl transition-all">
                  <i class="ti ti-download mr-2"></i>Generate
                </button>
              </div>
            </div>

            <!-- Waste Summary PDF -->
            <div class="glass-card rounded-2xl p-6 border border-slate-200 dark:border-slate-700">
              <div class="flex items-center space-x-3 mb-4">
                <div class="bg-red-100 dark:bg-red-900/30 p-3 rounded-xl">
                  <i class="ti ti-trash text-2xl text-red-600 dark:text-red-400"></i>
                </div>
                <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Waste Report</h3>
              </div>
              <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">Waste analytics and trends</p>
              <div class="space-y-3">
                <input type="date" id="pdfWasteFrom" class="w-full px-4 py-2 rounded-xl bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white">
                <input type="date" id="pdfWasteTo" class="w-full px-4 py-2 rounded-xl bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white">
                <button onclick="APP.generatePDF('waste')" class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-xl transition-all">
                  <i class="ti ti-download mr-2"></i>Generate
                </button>
              </div>
            </div>

            <!-- Daily Ops Sheet PDF -->
            <div class="glass-card rounded-2xl p-6 border border-slate-200 dark:border-slate-700">
              <div class="flex items-center space-x-3 mb-4">
                <div class="bg-purple-100 dark:bg-purple-900/30 p-3 rounded-xl">
                  <i class="ti ti-calendar-event text-2xl text-purple-600 dark:text-purple-400"></i>
                </div>
                <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Daily Ops</h3>
              </div>
              <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">Daily operations checklist</p>
              <div class="space-y-3">
                <input type="date" id="pdfOpsDate" class="w-full px-4 py-2 rounded-xl bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white">
                <button onclick="APP.generatePDF('ops')" class="w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-xl transition-all">
                  <i class="ti ti-download mr-2"></i>Generate
                </button>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Toast Notifications -->
  <div id="toastContainer" class="fixed bottom-6 right-6 z-50 space-y-3"></div>

  <script>
    // ==========================================
    // GLOBAL APP STATE
    // ==========================================
    const APP = {
      token: null,
      user: null,
      role: null,
      apiBase: localStorage.getItem('NP_API_URL') || 'https://inventory-backend-7-agent-build.up.railway.app',
      charts: {},

      // ==========================================
      // UTILITY FUNCTIONS
      // ==========================================
      async api(endpoint, options = {}) {
        const url = `${this.apiBase}${endpoint}`;
        const headers = {
          'Content-Type': 'application/json',
          ...(this.token && { 'Authorization': `Bearer ${this.token}` }),
          ...options.headers,
        };

        try {
          const response = await fetch(url, {
            ...options,
            headers,
          });

          if (response.status === 401) {
            this.logout();
            throw new Error('Session expired. Please login again.');
          }

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || data.message || 'Request failed');
          }

          return data;
        } catch (error) {
          console.error('API Error:', error);
          this.toast(error.message || 'Network error', 'error');
          throw error;
        }
      },

      toast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');

        const colors = {
          success: 'bg-green-500',
          error: 'bg-red-500',
          info: 'bg-blue-500',
          warning: 'bg-orange-500',
        };

        const icons = {
          success: 'ti-check',
          error: 'ti-alert-circle',
          info: 'ti-info-circle',
          warning: 'ti-alert-triangle',
        };

        toast.className = `${colors[type]} text-white px-6 py-4 rounded-xl shadow-2xl flex items-center space-x-3 transform transition-all duration-300 translate-x-0`;
        toast.innerHTML = `
          <i class="ti ${icons[type]} text-xl"></i>
          <span class="font-medium">${message}</span>
        `;

        container.appendChild(toast);

        setTimeout(() => {
          toast.style.transform = 'translateX(400px)';
          toast.style.opacity = '0';
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      },

      showSection(sectionId) {
        document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
        document.getElementById(sectionId).classList.remove('hidden');

        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('bg-blue-100', 'dark:bg-blue-900/30', 'text-blue-600', 'dark:text-blue-400', 'font-semibold'));

        const activeLink = document.querySelector(`a[href="#${sectionId.replace('Section', '')}"]`);
        if (activeLink) {
          activeLink.classList.add('bg-blue-100', 'dark:bg-blue-900/30', 'text-blue-600', 'dark:text-blue-400', 'font-semibold');
        }
      },

      // ==========================================
      // AUTHENTICATION
      // ==========================================
      async login(email, password) {
        try {
          const data = await this.api('/api/auth/login', {
            method: 'POST',
            body: JSON.stringify({ email, password }),
          });

          this.token = data.token;
          this.user = data.user;
          this.role = data.user.role;

          localStorage.setItem('NP_TOKEN', this.token);
          localStorage.setItem('NP_USER', JSON.stringify(this.user));

          document.getElementById('loginScreen').classList.add('hidden');
          document.getElementById('mainApp').classList.remove('hidden');
          document.getElementById('userDisplay').textContent = email;
          document.getElementById('roleDisplay').textContent = this.role.toUpperCase();

          this.toast(`Welcome back, ${email}!`, 'success');
          this.loadDashboard();
        } catch (error) {
          document.getElementById('loginError').textContent = error.message;
          document.getElementById('loginError').classList.remove('hidden');
        }
      },

      logout() {
        this.token = null;
        this.user = null;
        this.role = null;
        localStorage.removeItem('NP_TOKEN');
        localStorage.removeItem('NP_USER');

        document.getElementById('mainApp').classList.add('hidden');
        document.getElementById('loginScreen').classList.remove('hidden');

        this.toast('Logged out successfully', 'info');
      },

      // ==========================================
      // DASHBOARD
      // ==========================================
      async loadDashboard() {
        try {
          const data = await this.api('/api/inventory/summary');

          document.getElementById('dashTotalItems').textContent = data.data.total_items || 0;
          document.getElementById('dashTotalQty').textContent = data.data.total_quantity || 0;
          document.getElementById('dashLocations').textContent = data.data.total_locations || 0;
          document.getElementById('dashLowStock').textContent = data.data.low_stock_count || 0;

          this.renderCategoryChart();
          this.renderTrendChart();
        } catch (error) {
          console.error('Dashboard load failed:', error);
        }
      },

      renderCategoryChart() {
        const ctx = document.getElementById('categoryChart');
        if (this.charts.category) this.charts.category.destroy();

        this.charts.category = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Dairy', 'Produce', 'Meat', 'Dry Goods', 'Other'],
            datasets: [{
              data: [30, 25, 20, 15, 10],
              backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#64748b'],
            }],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' },
            },
          },
        });
      },

      renderTrendChart() {
        const ctx = document.getElementById('trendChart');
        if (this.charts.trend) this.charts.trend.destroy();

        this.charts.trend = new Chart(ctx, {
          type: 'line',
          data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
              label: 'Stock Level',
              data: [850, 920, 880, 950, 900, 870, 910],
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              tension: 0.4,
              fill: true,
            }],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
            },
            scales: {
              y: { beginAtZero: false },
            },
          },
        });
      },

      // ==========================================
      // ITEMS
      // ==========================================
      async loadItems() {
        try {
          const data = await this.api('/api/items');
          const tbody = document.getElementById('itemsTableBody');

          if (!data.data || data.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400">No items found</td></tr>';
            return;
          }

          tbody.innerHTML = data.data.map(item => `
            <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900 dark:text-white">${item.sku}</td>
              <td class="px-6 py-4 text-sm text-slate-700 dark:text-slate-300">${item.name}</td>
              <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-400">${item.category || '-'}</td>
              <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-400">${item.uom || '-'}</td>
              <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-400">${item.par_level || '-'}</td>
              <td class="px-6 py-4 text-sm">
                <span class="px-2 py-1 text-xs font-semibold rounded-full ${item.active ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'}">
                  ${item.active ? 'Active' : 'Inactive'}
                </span>
              </td>
            </tr>
          `).join('');
        } catch (error) {
          console.error('Failed to load items:', error);
        }
      },

      // ==========================================
      // INVENTORY
      // ==========================================
      async loadInventory() {
        try {
          const data = await this.api('/api/inventory');
          const tbody = document.getElementById('inventoryTableBody');

          if (!data.data || data.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400">No inventory records found</td></tr>';
            return;
          }

          tbody.innerHTML = data.data.map(inv => `
            <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900 dark:text-white">${inv.sku}</td>
              <td class="px-6 py-4 text-sm text-slate-700 dark:text-slate-300">${inv.item_name || '-'}</td>
              <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-400">${inv.location || '-'}</td>
              <td class="px-6 py-4 text-sm text-slate-900 dark:text-white font-semibold">${inv.quantity}</td>
              <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-400">${inv.lot || '-'}</td>
              <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-400">${inv.last_counted_at ? new Date(inv.last_counted_at).toLocaleDateString() : '-'}</td>
            </tr>
          `).join('');
        } catch (error) {
          console.error('Failed to load inventory:', error);
        }
      },

      // ==========================================
      // VENDORS
      // ==========================================
      async loadVendors() {
        try {
          const data = await this.api('/api/vendors');
          const tbody = document.getElementById('vendorsTableBody');
          const select = document.getElementById('preferredVendorSelect');

          if (!data.success || !data.data || data.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400">No vendors found</td></tr>';
            select.innerHTML = '<option value="">No vendors available</option>';
            return;
          }

          // Populate vendor select
          select.innerHTML = '<option value="">Select a vendor</option>' +
            data.data.map(v => `<option value="${v.id}">${v.name}</option>`).join('');

          // Populate table
          tbody.innerHTML = data.data.map(vendor => `
            <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900 dark:text-white">${vendor.name}</td>
              <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-400">${vendor.contact_email || '-'}</td>
              <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-400">${vendor.item_count || 0}</td>
              <td class="px-6 py-4 text-sm">
                <span class="px-2 py-1 text-xs font-semibold rounded-full ${vendor.active ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'}">
                  ${vendor.active ? 'Active' : 'Inactive'}
                </span>
              </td>
            </tr>
          `).join('');

          // Load current preferred vendor
          this.loadPreferredVendor();
        } catch (error) {
          console.error('Failed to load vendors:', error);
        }
      },

      async loadPreferredVendor() {
        try {
          const data = await this.api('/api/org/vendor-default');
          if (data.success && data.data && data.data.preferred_vendor_id) {
            document.getElementById('preferredVendorSelect').value = data.data.preferred_vendor_id;
          }
        } catch (error) {
          console.error('Failed to load preferred vendor:', error);
        }
      },

      async savePreferredVendor() {
        const vendorId = document.getElementById('preferredVendorSelect').value;
        if (!vendorId) {
          this.toast('Please select a vendor', 'warning');
          return;
        }

        try {
          await this.api('/api/org/vendor-default', {
            method: 'PUT',
            body: JSON.stringify({ vendor_id: parseInt(vendorId) }),
          });
          this.toast('Preferred vendor saved successfully', 'success');
        } catch (error) {
          console.error('Failed to save preferred vendor:', error);
        }
      },

      async lookupPrice() {
        const sku = document.getElementById('priceLookupSKU').value.trim();
        const date = document.getElementById('priceLookupDate').value;

        if (!sku) {
          this.toast('Please enter an item SKU', 'warning');
          return;
        }

        try {
          const params = new URLSearchParams({ item_sku: sku });
          if (date) params.append('at', date);

          const data = await this.api(`/api/vendors/prices?${params}`);
          const resultDiv = document.getElementById('priceLookupResult');

          if (data.success && data.data) {
            const price = data.data;
            resultDiv.innerHTML = `
              <div class="text-sm">
                <p class="font-semibold text-green-700 dark:text-green-400 mb-2">Price Found</p>
                <p><strong>Vendor:</strong> ${price.vendor_name || 'N/A'}</p>
                <p><strong>Price:</strong> $${price.price} ${price.currency || 'USD'}</p>
                <p><strong>Effective From:</strong> ${price.effective_from || 'N/A'}</p>
                <p><strong>Source:</strong> ${price.source || 'manual'}</p>
              </div>
            `;
            resultDiv.classList.remove('hidden');
          } else {
            resultDiv.innerHTML = `<p class="text-sm text-slate-600 dark:text-slate-400">No price found for this item</p>`;
            resultDiv.classList.remove('hidden');
          }
        } catch (error) {
          console.error('Price lookup failed:', error);
        }
      },

      // ==========================================
      // RECIPES
      // ==========================================
      async loadRecipes() {
        try {
          const data = await this.api('/api/recipes');
          const grid = document.getElementById('recipesGrid');

          if (!data.success || !data.data || data.data.length === 0) {
            grid.innerHTML = '<div class="glass-card rounded-2xl p-6 border border-slate-200 dark:border-slate-700"><p class="text-center text-slate-500 dark:text-slate-400">No recipes found</p></div>';
            return;
          }

          grid.innerHTML = data.data.map(recipe => `
            <div class="glass-card rounded-2xl p-6 border border-slate-200 dark:border-slate-700 hover:shadow-xl transition-all">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-slate-900 dark:text-white">${recipe.name}</h3>
                <span class="px-2 py-1 text-xs font-semibold rounded-full ${recipe.active ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'}">
                  ${recipe.active ? 'Active' : 'Inactive'}
                </span>
              </div>
              <p class="text-sm text-slate-600 dark:text-slate-400 mb-2">Code: ${recipe.code}</p>
              <p class="text-sm text-slate-600 dark:text-slate-400 mb-2">Yield: ${recipe.yield_qty} ${recipe.yield_uom}</p>
              <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">Prep Loss: ${recipe.prep_loss_pct}%</p>
              <button onclick="APP.viewRecipeCost(${recipe.id})" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl transition-all">
                <i class="ti ti-calculator mr-2"></i>View Cost
              </button>
            </div>
          `).join('');
        } catch (error) {
          console.error('Failed to load recipes:', error);
        }
      },

      async viewRecipeCost(recipeId) {
        try {
          const data = await this.api(`/api/recipes/${recipeId}/cost`);
          if (data.success && data.data) {
            const cost = data.data;
            alert(`Recipe Cost:\n\nTotal: $${cost.total_cost}\nUnit Cost: $${cost.unit_cost}\nPer Portion: $${cost.cost_per_portion}\n\nIngredients: ${cost.breakdown ? cost.breakdown.length : 0}`);
          }
        } catch (error) {
          console.error('Failed to get recipe cost:', error);
        }
      },

      // ==========================================
      // MENU PLANNING
      // ==========================================
      async loadMenu() {
        const week = document.getElementById('menuWeekSelect').value;
        try {
          const data = await this.api(`/api/menu/cycle?week=${week}`);
          const calendar = document.getElementById('menuCalendar');

          if (!data.success) {
            calendar.innerHTML = '<div class="col-span-7 text-center text-slate-500 dark:text-slate-400">Failed to load menu</div>';
            return;
          }

          // Create 7 day columns
          const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
          calendar.innerHTML = days.map((day, idx) => `
            <div class="glass-card rounded-xl p-4 border border-slate-200 dark:border-slate-700 min-h-[200px]">
              <p class="font-semibold text-slate-700 dark:text-slate-300 mb-3">${day}</p>
              <div class="space-y-2 text-sm text-slate-600 dark:text-slate-400">
                <p><strong>Breakfast:</strong> -</p>
                <p><strong>Lunch:</strong> -</p>
                <p><strong>Dinner:</strong> -</p>
              </div>
            </div>
          `).join('');
        } catch (error) {
          console.error('Failed to load menu:', error);
        }
      },

      async forecastMenuCost() {
        const week = document.getElementById('menuWeekSelect').value;
        const date = new Date().toISOString().split('T')[0];

        try {
          const data = await this.api(`/api/menu/forecast-cost?week=${week}&at=${date}`);
          const display = document.getElementById('costForecastDisplay');
          const content = document.getElementById('costForecastContent');

          if (data.success && data.data) {
            content.innerHTML = `
              <div class="grid grid-cols-3 gap-4">
                <div class="text-center">
                  <p class="text-2xl font-bold text-slate-900 dark:text-white">$${data.data.total_cost || 0}</p>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Total Cost</p>
                </div>
                <div class="text-center">
                  <p class="text-2xl font-bold text-slate-900 dark:text-white">${data.data.total_portions || 0}</p>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Total Portions</p>
                </div>
                <div class="text-center">
                  <p class="text-2xl font-bold text-slate-900 dark:text-white">$${data.data.cost_per_portion || 0}</p>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Per Portion</p>
                </div>
              </div>
            `;
            display.classList.remove('hidden');
          }
        } catch (error) {
          console.error('Failed to forecast cost:', error);
        }
      },

      // ==========================================
      // POPULATION
      // ==========================================
      async loadPopulation() {
        try {
          const data = await this.api('/api/population');
          const tbody = document.getElementById('populationTableBody');

          if (!data.success || !data.data || data.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400">No population data found</td></tr>';
            return;
          }

          tbody.innerHTML = data.data.map(pop => `
            <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900 dark:text-white">${pop.date}</td>
              <td class="px-6 py-4 text-sm text-slate-900 dark:text-white font-semibold">${pop.population}</td>
              <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-400">${pop.notes || '-'}</td>
              <td class="px-6 py-4 text-sm">
                <button onclick="APP.deletePopulation(${pop.id})" class="text-red-600 hover:text-red-700 dark:text-red-400">
                  <i class="ti ti-trash"></i>
                </button>
              </td>
            </tr>
          `).join('');

          this.renderPopulationChart(data.data);
        } catch (error) {
          console.error('Failed to load population:', error);
        }
      },

      renderPopulationChart(data) {
        const ctx = document.getElementById('populationChart');
        if (this.charts.population) this.charts.population.destroy();

        const labels = data.map(d => d.date).slice(-30);
        const values = data.map(d => d.population).slice(-30);

        this.charts.population = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Daily Population',
              data: values,
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              tension: 0.4,
              fill: true,
            }],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
            },
          },
        });
      },

      async deletePopulation(id) {
        if (!confirm('Delete this population entry?')) return;

        try {
          await this.api(`/api/population/${id}`, { method: 'DELETE' });
          this.toast('Population entry deleted', 'success');
          this.loadPopulation();
        } catch (error) {
          console.error('Failed to delete population:', error);
        }
      },

      // ==========================================
      // WASTE
      // ==========================================
      async loadWaste() {
        try {
          const data = await this.api('/api/waste');
          const tbody = document.getElementById('wasteTableBody');

          if (!data.success || !data.data || data.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-slate-500 dark:text-slate-400">No waste events found</td></tr>';
            return;
          }

          tbody.innerHTML = data.data.map(waste => `
            <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
              <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-white">${new Date(waste.event_ts).toLocaleDateString()}</td>
              <td class="px-6 py-4 text-sm text-slate-700 dark:text-slate-300">${waste.item_sku || waste.recipe_code || '-'}</td>
              <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-400">${waste.qty} ${waste.uom}</td>
              <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-400">${waste.reason} ${waste.subreason ? `(${waste.subreason})` : ''}</td>
              <td class="px-6 py-4 text-sm font-semibold text-red-600 dark:text-red-400">$${waste.cost_at_event || 0}</td>
            </tr>
          `).join('');

          this.loadWasteAnalytics();
        } catch (error) {
          console.error('Failed to load waste:', error);
        }
      },

      async loadWasteAnalytics() {
        try {
          const data = await this.api('/api/waste/summary?group=reason');

          if (data.success && data.data) {
            this.renderWasteReasonChart(data.data);
          }
        } catch (error) {
          console.error('Failed to load waste analytics:', error);
        }
      },

      renderWasteReasonChart(data) {
        const ctx = document.getElementById('wasteReasonChart');
        if (this.charts.wasteReason) this.charts.wasteReason.destroy();

        const labels = data.map(d => d.reason || 'Unknown');
        const values = data.map(d => d.total_cost || 0);

        this.charts.wasteReason = new Chart(ctx, {
          type: 'pie',
          data: {
            labels,
            datasets: [{
              data: values,
              backgroundColor: ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6'],
            }],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' },
            },
          },
        });
      },

      // ==========================================
      // PDF GENERATION
      // ==========================================
      async generatePDF(type) {
        let params = { type };

        switch (type) {
          case 'count':
            params.params = { date: document.getElementById('pdfCountDate').value || new Date().toISOString().split('T')[0] };
            break;
          case 'menu':
            params.params = { week: parseInt(document.getElementById('pdfMenuWeek').value) };
            break;
          case 'waste':
            params.params = {
              from: document.getElementById('pdfWasteFrom').value,
              to: document.getElementById('pdfWasteTo').value,
            };
            break;
          case 'ops':
            params.params = { date: document.getElementById('pdfOpsDate').value || new Date().toISOString().split('T')[0] };
            break;
        }

        try {
          this.toast('Generating PDF...', 'info');

          const response = await fetch(`${this.apiBase}/api/pdfs/generate`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${this.token}`,
            },
            body: JSON.stringify(params),
          });

          if (!response.ok) {
            throw new Error('PDF generation failed');
          }

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${type}_report_${new Date().toISOString().split('T')[0]}.txt`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);

          this.toast('PDF downloaded successfully', 'success');
        } catch (error) {
          console.error('PDF generation failed:', error);
          this.toast('PDF generation failed', 'error');
        }
      },

      // ==========================================
      // THEME
      // ==========================================
      toggleTheme() {
        const html = document.documentElement;
        const isDark = html.classList.contains('dark');

        if (isDark) {
          html.classList.remove('dark');
          localStorage.setItem('theme', 'light');
        } else {
          html.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        }
      },

      initTheme() {
        const theme = localStorage.getItem('theme') || 'light';
        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
        }
      },
    };

    // ==========================================
    // EVENT LISTENERS
    // ==========================================
    document.addEventListener('DOMContentLoaded', () => {
      APP.initTheme();

      // Auto-login if token exists
      const savedToken = localStorage.getItem('NP_TOKEN');
      const savedUser = localStorage.getItem('NP_USER');

      if (savedToken && savedUser) {
        APP.token = savedToken;
        APP.user = JSON.parse(savedUser);
        APP.role = APP.user.role;

        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        document.getElementById('userDisplay').textContent = APP.user.email;
        document.getElementById('roleDisplay').textContent = APP.role.toUpperCase();

        APP.loadDashboard();
      }

      // Login form
      document.getElementById('loginForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const email = document.getElementById('emailInput').value;
        const password = document.getElementById('passwordInput').value;
        APP.login(email, password);
      });

      // Logout
      document.getElementById('logoutBtn').addEventListener('click', () => APP.logout());

      // Theme toggle
      document.getElementById('themeToggle').addEventListener('click', () => APP.toggleTheme());

      // Refresh button
      document.getElementById('refreshBtn').addEventListener('click', () => {
        const activeSection = document.querySelector('.section:not(.hidden)');
        if (activeSection) {
          const sectionId = activeSection.id;
          if (sectionId === 'dashboardSection') APP.loadDashboard();
          else if (sectionId === 'itemsSection') APP.loadItems();
          else if (sectionId === 'inventorySection') APP.loadInventory();
          else if (sectionId === 'vendorsSection') APP.loadVendors();
          else if (sectionId === 'recipesSection') APP.loadRecipes();
          else if (sectionId === 'menuSection') APP.loadMenu();
          else if (sectionId === 'populationSection') APP.loadPopulation();
          else if (sectionId === 'wasteSection') APP.loadWaste();
        }
      });

      // Navigation links
      document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const target = link.getAttribute('href').substring(1);
          const sectionId = target + 'Section';

          APP.showSection(sectionId);

          // Load section data
          if (target === 'dashboard') APP.loadDashboard();
          else if (target === 'items') APP.loadItems();
          else if (target === 'inventory') APP.loadInventory();
          else if (target === 'vendors') APP.loadVendors();
          else if (target === 'recipes') APP.loadRecipes();
          else if (target === 'menu') APP.loadMenu();
          else if (target === 'population') APP.loadPopulation();
          else if (target === 'waste') APP.loadWaste();
        });
      });

      // Item refresh
      document.getElementById('itemRefreshBtn')?.addEventListener('click', () => APP.loadItems());

      // Vendor actions
      document.getElementById('savePreferredVendorBtn')?.addEventListener('click', () => APP.savePreferredVendor());
      document.getElementById('lookupPriceBtn')?.addEventListener('click', () => APP.lookupPrice());

      // Menu actions
      document.getElementById('menuWeekSelect')?.addEventListener('change', () => APP.loadMenu());
      document.getElementById('forecastCostBtn')?.addEventListener('click', () => APP.forecastMenuCost());

      // Set default dates for PDF generation
      const today = new Date().toISOString().split('T')[0];
      const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

      if (document.getElementById('pdfCountDate')) document.getElementById('pdfCountDate').value = today;
      if (document.getElementById('pdfOpsDate')) document.getElementById('pdfOpsDate').value = today;
      if (document.getElementById('pdfWasteFrom')) document.getElementById('pdfWasteFrom').value = thirtyDaysAgo;
      if (document.getElementById('pdfWasteTo')) document.getElementById('pdfWasteTo').value = today;
      if (document.getElementById('priceLookupDate')) document.getElementById('priceLookupDate').value = today;
    });
  </script>
</body>
</html>
