<!DOCTYPE html>
<html>
<head>
    <title>Date Fix Test - NeuroPilot</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 2rem;
            background: #f9fafb;
        }
        .test-card {
            background: white;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .success { color: #10b981; font-weight: 600; }
        .error { color: #ef4444; font-weight: 600; }
        .code {
            background: #1f2937;
            color: #10b981;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            overflow-x: auto;
            margin: 0.5rem 0;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        button:hover { background: #1d4ed8; }
    </style>
</head>
<body>
    <h1>üß™ Date Display Fix Test</h1>
    <p><strong>Invoice:</strong> 9027091044</p>
    <p><strong>Expected Date:</strong> September 20, 2025</p>
    <p><strong>Database Value:</strong> 2025-09-20</p>

    <hr style="margin: 1.5rem 0; border: none; border-top: 2px solid #e5e7eb;">

    <div class="test-card">
        <h2>Test 1: JavaScript Date Parsing</h2>
        <div id="test1-result"></div>
        <div class="code" id="test1-code"></div>
    </div>

    <div class="test-card">
        <h2>Test 2: API Response</h2>
        <button onclick="testAPI()">üì° Test API /owner/pdfs</button>
        <div id="test2-result"></div>
        <div class="code" id="test2-code"></div>
    </div>

    <div class="test-card">
        <h2>Test 3: Cache Status</h2>
        <div id="test3-result"></div>
        <div class="code" id="test3-code"></div>
    </div>

    <div class="test-card">
        <h2>Troubleshooting Steps</h2>
        <ol>
            <li><strong>Clear Browser Cache:</strong>
                <ul>
                    <li>Chrome/Edge: Ctrl+Shift+Delete (or Cmd+Shift+Delete on Mac)</li>
                    <li>Select "Cached images and files"</li>
                    <li>Click "Clear data"</li>
                </ul>
            </li>
            <li><strong>Hard Refresh:</strong> Ctrl+Shift+R (or Cmd+Shift+R on Mac)</li>
            <li><strong>Incognito/Private Window:</strong> Open console in private browsing mode</li>
            <li><strong>Check Console for Errors:</strong> Press F12, look for red errors</li>
        </ol>
    </div>

    <script>
        const API_BASE = 'http://localhost:8083/api';

        // Test 1: JavaScript Date Parsing
        function test1() {
            const invoiceDate = "2025-09-20";

            // OLD METHOD (broken)
            const oldDate = new Date(invoiceDate);
            const oldDisplay = oldDate.toLocaleDateString();

            // NEW METHOD (fixed)
            const [year, month, day] = invoiceDate.split('-');
            const newDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            const newDisplay = newDate.toLocaleDateString();

            const result = document.getElementById('test1-result');
            const code = document.getElementById('test1-code');

            result.innerHTML = `
                <p>OLD METHOD: <span class="error">${oldDisplay}</span> (timezone bug)</p>
                <p>NEW METHOD: <span class="success">${newDisplay}</span> (correct!)</p>
            `;

            code.textContent = `
Database: "${invoiceDate}"
OLD: new Date("${invoiceDate}").toLocaleDateString() = "${oldDisplay}"
NEW: Split & parse = "${newDisplay}"
Timezone offset: ${new Date().getTimezoneOffset()} minutes
            `.trim();
        }

        // Test 2: API Response
        async function testAPI() {
            const result = document.getElementById('test2-result');
            const code = document.getElementById('test2-code');

            result.innerHTML = '<p>Loading...</p>';

            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    result.innerHTML = '<p class="error">No auth token found. Please login first at /owner-super-console.html</p>';
                    return;
                }

                const response = await fetch(`${API_BASE}/owner/pdfs?limit=5`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                const invoice = data.data.find(pdf => pdf.invoiceNumber === '9027091044');

                if (invoice) {
                    // Apply the fix
                    const dateStr = invoice.invoiceDate;
                    let dateDisplay = 'N/A';
                    if (dateStr && dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        const [year, month, day] = dateStr.split('-');
                        const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                        dateDisplay = date.toLocaleDateString();
                    }

                    result.innerHTML = `
                        <p><span class="success">‚úÖ Found invoice 9027091044</span></p>
                        <p>API returned: <code>${invoice.invoiceDate}</code></p>
                        <p>Display as: <strong>${dateDisplay}</strong></p>
                    `;

                    code.textContent = JSON.stringify(invoice, null, 2);
                } else {
                    result.innerHTML = '<p class="error">Invoice 9027091044 not found in response</p>';
                    code.textContent = JSON.stringify(data.data.slice(0, 3), null, 2);
                }
            } catch (error) {
                result.innerHTML = `<p class="error">‚ùå API Error: ${error.message}</p>`;
                code.textContent = error.stack;
            }
        }

        // Test 3: Cache Status
        function test3() {
            const result = document.getElementById('test3-result');
            const code = document.getElementById('test3-code');

            const jsFile = 'owner-super-console.js';
            const expectedVersion = '13.1.1';

            // Check if version parameter exists
            const scripts = Array.from(document.querySelectorAll('script'));
            const hasVersion = scripts.some(s => s.src.includes(`${jsFile}?v=`));

            result.innerHTML = `
                <p>Expected: <code>${jsFile}?v=${expectedVersion}</code></p>
                <p>Status: ${hasVersion ? '<span class="success">‚úÖ Cache-busting enabled</span>' : '<span class="error">‚ùå No version parameter found</span>'}</p>
            `;

            code.textContent = `
Current page: ${window.location.href}
Script tags: ${scripts.length}
Has cache-busting: ${hasVersion}
Browser: ${navigator.userAgent.substring(0, 50)}...
            `.trim();
        }

        // Run tests on load
        window.addEventListener('DOMContentLoaded', () => {
            test1();
            test3();
        });
    </script>
</body>
</html>
