1<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner Console | NeuroInnovate v2.8.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .status-badge {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="antialiased">
    <div id="app" class="min-h-screen p-6">
        <!-- Header -->
        <header class="glass-effect rounded-2xl p-6 mb-6 shadow-2xl">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-4xl font-bold text-white mb-2">üß† NeuroInnovate Owner Console</h1>
                    <p class="text-purple-200">System Administrator: David Mikulis | v2.8.0</p>
                </div>
                <div class="text-right">
                    <div class="status-badge bg-green-500 text-white px-4 py-2 rounded-full text-sm font-semibold mb-2">
                        ‚óè SYSTEM OPERATIONAL
                    </div>
                    <p class="text-purple-100 text-sm" id="currentTime"></p>
                </div>
            </div>
        </header>

        <!-- Main Dashboard Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- System Status Panel -->
            <div class="glass-effect rounded-2xl p-6 shadow-2xl">
                <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                    <span class="text-3xl mr-3">‚ö°</span> System Status
                </h2>
                <div id="systemStatus" class="space-y-3">
                    <div class="bg-white/10 rounded-lg p-4">
                        <div class="flex justify-between items-center">
                            <span class="text-purple-100">Loading system health...</span>
                            <div class="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Modules Panel -->
            <div class="glass-effect rounded-2xl p-6 shadow-2xl">
                <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                    <span class="text-3xl mr-3">ü§ñ</span> AI Modules
                </h2>
                <div id="aiModules" class="space-y-3">
                    <div class="bg-white/10 rounded-lg p-4">
                        <div class="flex justify-between items-center">
                            <span class="text-purple-100">Loading AI module status...</span>
                            <div class="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Database Metrics Panel -->
            <div class="glass-effect rounded-2xl p-6 shadow-2xl">
                <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                    <span class="text-3xl mr-3">üíæ</span> Database Metrics
                </h2>
                <div id="dbMetrics" class="space-y-3">
                    <div class="bg-white/10 rounded-lg p-4">
                        <div class="flex justify-between items-center">
                            <span class="text-purple-100">Loading database stats...</span>
                            <div class="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity Panel -->
            <div class="glass-effect rounded-2xl p-6 shadow-2xl">
                <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                    <span class="text-3xl mr-3">üìã</span> Recent Activity
                </h2>
                <div id="recentActivity" class="space-y-2 max-h-80 overflow-y-auto">
                    <div class="bg-white/10 rounded-lg p-4">
                        <span class="text-purple-100">Loading audit logs...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Operational Intelligence Widgets -->
        <div class="mb-6">
            <h2 class="text-3xl font-bold text-white mb-4 flex items-center">
                <span class="text-4xl mr-3">ü§ñ</span> AI Operational Intelligence
            </h2>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Reorder Recommendations Widget -->
            <div class="glass-effect rounded-2xl p-6 shadow-2xl">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center justify-between">
                    <span><span class="text-2xl mr-2">üîÑ</span> Reorder Recommendations</span>
                    <button onclick="refreshReorderWidget()" class="text-sm bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg">Refresh</button>
                </h3>
                <div id="reorderWidget" class="space-y-3 max-h-96 overflow-y-auto">
                    <div class="bg-white/10 rounded-lg p-4">
                        <span class="text-purple-100">Loading recommendations...</span>
                    </div>
                </div>
                <button onclick="showCreateDraftPOModal()" class="mt-4 w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transform transition hover:scale-105">
                    Create Draft PO
                </button>
            </div>

            <!-- Anomaly Watchlist Widget -->
            <div class="glass-effect rounded-2xl p-6 shadow-2xl">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center justify-between">
                    <span><span class="text-2xl mr-2">‚ö†Ô∏è</span> Anomaly Watchlist</span>
                    <button onclick="refreshAnomalyWidget()" class="text-sm bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg">Refresh</button>
                </h3>
                <div id="anomalyWidget" class="space-y-3 max-h-96 overflow-y-auto">
                    <div class="bg-white/10 rounded-lg p-4">
                        <span class="text-purple-100">Loading anomalies...</span>
                    </div>
                </div>
            </div>

            <!-- System Upgrade Advisor Widget -->
            <div class="glass-effect rounded-2xl p-6 shadow-2xl">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center justify-between">
                    <span><span class="text-2xl mr-2">üí°</span> System Upgrade Advisor</span>
                    <button onclick="refreshAdvisorWidget()" class="text-sm bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg">Refresh</button>
                </h3>
                <div id="advisorWidget" class="space-y-3">
                    <div class="bg-white/10 rounded-lg p-4">
                        <span class="text-purple-100">Loading system analysis...</span>
                    </div>
                </div>
                <button id="applyUpgradeBtn" onclick="applyNextBestAction()" class="mt-4 w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transform transition hover:scale-105" disabled>
                    Apply Next Best Action
                </button>
            </div>
        </div>

        <!-- Control Center -->
        <div class="glass-effect rounded-2xl p-6 shadow-2xl mb-6">
            <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                <span class="text-3xl mr-3">‚öôÔ∏è</span> Control Center
            </h2>
            <div class="grid grid-cols-2 lg:grid-cols-5 gap-4">
                <button onclick="trainForecast()" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold py-4 px-6 rounded-xl shadow-lg transform transition hover:scale-105">
                    <div class="text-2xl mb-2">üß†</div>
                    <div class="text-sm">Train Forecast</div>
                </button>
                <button onclick="reloadAI()" class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold py-4 px-6 rounded-xl shadow-lg transform transition hover:scale-105">
                    <div class="text-2xl mb-2">üîÑ</div>
                    <div class="text-sm">Reload AI</div>
                </button>
                <button onclick="runCompliance()" class="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-semibold py-4 px-6 rounded-xl shadow-lg transform transition hover:scale-105">
                    <div class="text-2xl mb-2">üîê</div>
                    <div class="text-sm">Compliance Scan</div>
                </button>
                <button onclick="backupDatabase()" class="bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-semibold py-4 px-6 rounded-xl shadow-lg transform transition hover:scale-105">
                    <div class="text-2xl mb-2">üíæ</div>
                    <div class="text-sm">Backup DB</div>
                </button>
                <button onclick="refreshData()" class="bg-gradient-to-r from-pink-500 to-pink-600 hover:from-pink-600 hover:to-pink-700 text-white font-semibold py-4 px-6 rounded-xl shadow-lg transform transition hover:scale-105">
                    <div class="text-2xl mb-2">üìà</div>
                    <div class="text-sm">Refresh Metrics</div>
                </button>
            </div>
        </div>

        <!-- Version & Progress -->
        <div class="glass-effect rounded-2xl p-6 shadow-2xl mb-6">
            <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                <span class="text-3xl mr-3">üöÄ</span> System Progress
            </h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-xl font-semibold text-white mb-3">‚úÖ What's Working</h3>
                    <ul id="workingFeatures" class="space-y-2 text-green-200">
                        <!-- Populated by JS -->
                    </ul>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-white mb-3">üî® What's Next</h3>
                    <ul id="pendingFeatures" class="space-y-2 text-yellow-200">
                        <!-- Populated by JS -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="glass-effect rounded-2xl p-4 shadow-2xl text-center text-white">
            <p>¬© 2025 NeuroInnovate ¬∑ Proprietary System ¬∑ Owned and operated by David Mikulis</p>
            <p class="text-purple-200 text-sm mt-2">Last refresh: <span id="lastRefresh">--:--:--</span></p>
        </footer>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 hidden">
        <div class="glass-effect text-white px-6 py-4 rounded-xl shadow-2xl">
            <p id="toastMessage"></p>
        </div>
    </div>

    <!-- Draft PO Modal -->
    <div id="draftPOModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center z-50">
        <div class="glass-effect rounded-2xl p-8 max-w-2xl w-full mx-4 shadow-2xl">
            <h3 class="text-2xl font-bold text-white mb-4">Create Draft Purchase Order</h3>
            <div id="draftPOItems" class="space-y-2 max-h-96 overflow-y-auto mb-4">
                <!-- Items populated by JS -->
            </div>
            <div class="flex justify-end gap-4">
                <button onclick="closeDraftPOModal()" class="bg-white/20 hover:bg-white/30 text-white font-semibold py-2 px-6 rounded-xl">
                    Cancel
                </button>
                <button onclick="confirmCreateDraftPO()" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold py-2 px-6 rounded-xl">
                    Confirm Create Draft PO
                </button>
            </div>
        </div>
    </div>

    <!-- Confirm Action Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center z-50">
        <div class="glass-effect rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <h3 class="text-2xl font-bold text-white mb-4">Confirm Action</h3>
            <p id="confirmMessage" class="text-white mb-6"></p>
            <div class="flex justify-end gap-4">
                <button onclick="closeConfirmModal()" class="bg-white/20 hover:bg-white/30 text-white font-semibold py-2 px-6 rounded-xl">
                    Cancel
                </button>
                <button id="confirmBtn" class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold py-2 px-6 rounded-xl">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:8083/api';
        let token = localStorage.getItem('authToken');
        let autoRefreshInterval = null;
        let inactivityTimer = null;

        // Auto-logout after 30 minutes
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                showToast('Session expired due to inactivity', 'error');
                setTimeout(() => window.location.href = '/login.html', 2000);
            }, 30 * 60 * 1000); // 30 minutes
        }

        // Setup inactivity detection
        ['mousedown', 'keypress', 'scroll', 'touchstart'].forEach(event => {
            document.addEventListener(event, resetInactivityTimer);
        });
        resetInactivityTimer();

        // Update current time
        function updateTime() {
            document.getElementById('currentTime').textContent = new Date().toLocaleString();
        }
        setInterval(updateTime, 1000);
        updateTime();

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // API call wrapper with authentication
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const config = {
                    method,
                    url: `${API_BASE}${endpoint}`,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                };
                if (data) config.data = data;

                const response = await axios(config);
                return response.data;
            } catch (error) {
                if (error.response?.status === 401 || error.response?.status === 403) {
                    showToast('Authentication failed. Please log in.', 'error');
                    setTimeout(() => window.location.href = '/login.html', 2000);
                }
                throw error;
            }
        }

        // Load dashboard data
        async function loadDashboard() {
            try {
                const data = await apiCall('/owner/dashboard');

                // Update system status
                renderSystemStatus(data.data.health);

                // Update AI modules
                renderAIModules(data.data.aiModules);

                // Update database metrics
                renderDBMetrics(data.data.dbStats);

                // Update audit logs
                renderAuditLogs(data.data.auditLogs);

                // Update version info
                renderVersionInfo(data.data.versionInfo);

                // Update last refresh time
                document.getElementById('lastRefresh').textContent = new Date().toLocaleTimeString();

                showToast('Dashboard refreshed successfully');
            } catch (error) {
                console.error('Dashboard load error:', error);
                showToast('Failed to load dashboard data', 'error');
            }
        }

        // Render system status
        function renderSystemStatus(health) {
            const container = document.getElementById('systemStatus');
            container.innerHTML = `
                <div class="bg-white/10 rounded-lg p-4 space-y-2">
                    <div class="flex justify-between">
                        <span class="text-purple-100">Status</span>
                        <span class="text-green-300 font-semibold">${health.status.toUpperCase()}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-purple-100">Version</span>
                        <span class="text-white font-semibold">${health.version}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-purple-100">Uptime</span>
                        <span class="text-white">${Math.floor(health.uptime / 60)} minutes</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-purple-100">Memory</span>
                        <span class="text-white">${(health.memory.heapUsed / 1024 / 1024).toFixed(2)} MB</span>
                    </div>
                </div>
            `;
        }

        // Render AI modules
        function renderAIModules(modules) {
            const container = document.getElementById('aiModules');
            let html = '';

            Object.entries(modules).forEach(([name, module]) => {
                const statusColor = module.enabled ? 'bg-green-500' : 'bg-gray-500';
                html += `
                    <div class="bg-white/10 rounded-lg p-4">
                        <div class="flex justify-between items-center">
                            <span class="text-white font-semibold capitalize">${name}</span>
                            <span class="${statusColor} px-3 py-1 rounded-full text-xs text-white">
                                ${module.status.toUpperCase()}
                            </span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Render database metrics
        function renderDBMetrics(stats) {
            const container = document.getElementById('dbMetrics');
            let html = '<div class="bg-white/10 rounded-lg p-4 space-y-2">';

            Object.entries(stats).forEach(([key, value]) => {
                html += `
                    <div class="flex justify-between">
                        <span class="text-purple-100 capitalize">${key.replace(/_/g, ' ')}</span>
                        <span class="text-white font-semibold">${value}</span>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Render audit logs
        function renderAuditLogs(logs) {
            const container = document.getElementById('recentActivity');
            let html = '';

            logs.forEach(log => {
                const severityColors = {
                    'CRITICAL': 'bg-red-500',
                    'WARNING': 'bg-yellow-500',
                    'INFO': 'bg-blue-500'
                };

                html += `
                    <div class="bg-white/10 rounded-lg p-3">
                        <div class="flex justify-between items-start mb-1">
                            <span class="${severityColors[log.severity] || 'bg-gray-500'} px-2 py-1 rounded text-xs text-white">
                                ${log.event_type}
                            </span>
                            <span class="text-purple-200 text-xs">${new Date(log.created_at).toLocaleTimeString()}</span>
                        </div>
                        <p class="text-white text-sm">${log.action} ${log.endpoint}</p>
                        <p class="text-purple-200 text-xs">${log.user_email || 'Anonymous'}</p>
                    </div>
                `;
            });

            container.innerHTML = html || '<p class="text-purple-100">No recent activity</p>';
        }

        // Render version info
        function renderVersionInfo(versionInfo) {
            const workingList = document.getElementById('workingFeatures');
            const pendingList = document.getElementById('pendingFeatures');

            workingList.innerHTML = versionInfo.features.completed
                .map(feature => `<li class="flex items-center"><span class="mr-2">‚úÖ</span>${feature}</li>`)
                .join('');

            pendingList.innerHTML = versionInfo.features.pending
                .map(feature => `<li class="flex items-center"><span class="mr-2">üî®</span>${feature}</li>`)
                .join('');
        }

        // Control Center Actions
        async function trainForecast() {
            try {
                const itemCode = prompt('Enter item code for forecast training:', 'APPLE-001');
                if (!itemCode) return;

                const result = await apiCall('/owner/train-forecast', 'POST', { itemCode, horizon: 30 });
                showToast(`Forecast training initiated for ${itemCode}`);
            } catch (error) {
                showToast('Failed to start forecast training', 'error');
            }
        }

        async function reloadAI() {
            try {
                const result = await apiCall('/owner/reload-ai', 'POST');
                showToast('AI agents reloading...');
            } catch (error) {
                showToast('Failed to reload AI agents', 'error');
            }
        }

        async function runCompliance() {
            try {
                const result = await apiCall('/owner/compliance-scan', 'POST');
                showToast('Compliance scan initiated');
            } catch (error) {
                showToast('Failed to start compliance scan', 'error');
            }
        }

        async function backupDatabase() {
            try {
                const result = await apiCall('/owner/backup-database', 'POST', { type: 'sqlite' });
                showToast(`Database backup completed: ${result.file}`);
            } catch (error) {
                showToast('Failed to backup database', 'error');
            }
        }

        async function refreshData() {
            loadDashboard();
            loadAIWidgets();
        }

        // ===== AI OPERATIONAL INTELLIGENCE WIDGETS =====

        // Global state for AI widgets
        let reorderData = [];
        let anomalyData = [];
        let upgradeAdvice = null;
        let selectedReorderItems = [];

        // Load all AI widgets
        async function loadAIWidgets() {
            await Promise.all([
                loadReorderWidget(),
                loadAnomalyWidget(),
                loadAdvisorWidget()
            ]);
        }

        // === Reorder Recommendations Widget ===
        async function loadReorderWidget() {
            const startTime = Date.now();
            try {
                const data = await apiCall('/owner/ai/reorder/top?n=10');
                reorderData = data.recommendations || [];
                renderReorderWidget(reorderData);
                const latency = (Date.now() - startTime) / 1000;
                console.log(`Reorder widget loaded in ${latency}s`);
            } catch (error) {
                console.error('Failed to load reorder recommendations:', error);
                document.getElementById('reorderWidget').innerHTML = `
                    <div class="bg-red-500/20 rounded-lg p-4">
                        <span class="text-red-200">Failed to load recommendations</span>
                    </div>
                `;
            }
        }

        function renderReorderWidget(items) {
            const container = document.getElementById('reorderWidget');
            if (!items || items.length === 0) {
                container.innerHTML = '<div class="bg-white/10 rounded-lg p-4"><span class="text-purple-100">No reorder recommendations at this time</span></div>';
                return;
            }

            let html = '';
            items.forEach(item => {
                const urgency = getUrgencyClass(item.projectedStockoutDate);
                const confidencePct = (item.confidence * 100).toFixed(0);

                html += `
                    <div class="${urgency.bg} rounded-lg p-4 border ${urgency.border}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <h4 class="font-bold text-white">${item.name}</h4>
                                <p class="text-xs text-gray-700">${item.itemCode}</p>
                            </div>
                            <span class="text-xs px-2 py-1 bg-white/80 rounded-full font-semibold">
                                ${confidencePct}% confidence
                            </span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>
                                <span class="text-gray-600">Stock:</span>
                                <span class="font-semibold text-gray-900">${item.currentStock}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Demand:</span>
                                <span class="font-semibold text-gray-900">${item.predictedDemand}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Stockout:</span>
                                <span class="font-semibold text-gray-900">${item.projectedStockoutDate}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Rec. Qty:</span>
                                <span class="font-semibold text-green-700">${item.recommendedReorderQty}</span>
                            </div>
                        </div>
                        <div class="mt-2">
                            <span class="text-xs text-gray-600">Drivers:</span>
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${item.drivers.map(driver => `
                                    <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded-full">
                                        ${driver}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function getUrgencyClass(stockoutDate) {
            const days = Math.floor((new Date(stockoutDate) - new Date()) / 86400000);
            if (days < 7) return { bg: 'bg-red-50', border: 'border-red-300' };
            if (days < 14) return { bg: 'bg-yellow-50', border: 'border-yellow-300' };
            return { bg: 'bg-green-50', border: 'border-green-300' };
        }

        async function refreshReorderWidget() {
            await loadReorderWidget();
            showToast('Reorder recommendations refreshed');
        }

        function showCreateDraftPOModal() {
            if (!reorderData || reorderData.length === 0) {
                showToast('No recommendations to create PO from', 'error');
                return;
            }

            const itemsHtml = reorderData.map(item => `
                <div class="flex items-center gap-3 bg-white/10 rounded-lg p-3">
                    <input type="checkbox" id="item_${item.itemCode}" value="${item.itemCode}"
                           class="w-5 h-5 rounded" data-qty="${item.recommendedReorderQty}"
                           data-name="${item.name}" data-stockout="${item.projectedStockoutDate}">
                    <label for="item_${item.itemCode}" class="flex-1 text-white cursor-pointer">
                        <div class="font-semibold">${item.name}</div>
                        <div class="text-sm text-purple-200">Qty: ${item.recommendedReorderQty} | Stockout: ${item.projectedStockoutDate}</div>
                    </label>
                </div>
            `).join('');

            document.getElementById('draftPOItems').innerHTML = itemsHtml;
            document.getElementById('draftPOModal').classList.remove('hidden');
        }

        function closeDraftPOModal() {
            document.getElementById('draftPOModal').classList.add('hidden');
        }

        async function confirmCreateDraftPO() {
            const checkedItems = Array.from(document.querySelectorAll('#draftPOItems input:checked'));

            if (checkedItems.length === 0) {
                showToast('Please select at least one item', 'error');
                return;
            }

            const items = checkedItems.map(input => ({
                itemCode: input.value,
                qty: parseInt(input.dataset.qty),
                rationale: `Projected stockout ${input.dataset.stockout}`
            }));

            try {
                const result = await apiCall('/owner/ai/reorder/create-draft', 'POST', { items });
                showToast(`Draft PO ${result.draftId} created with ${result.lineCount} items`);
                closeDraftPOModal();
                await loadReorderWidget(); // Refresh
            } catch (error) {
                if (error.response?.status === 429) {
                    showToast(`Rate limit: ${error.response.data.message}`, 'error');
                } else {
                    showToast('Failed to create draft PO', 'error');
                }
            }
        }

        // === Anomaly Watchlist Widget ===
        async function loadAnomalyWidget() {
            const startTime = Date.now();
            try {
                const data = await apiCall('/owner/ai/anomalies/recent?window=7d');
                anomalyData = data.anomalies || [];
                renderAnomalyWidget(anomalyData);
                const latency = (Date.now() - startTime) / 1000;
                console.log(`Anomaly widget loaded in ${latency}s`);
            } catch (error) {
                console.error('Failed to load anomalies:', error);
                document.getElementById('anomalyWidget').innerHTML = `
                    <div class="bg-red-500/20 rounded-lg p-4">
                        <span class="text-red-200">Failed to load anomalies</span>
                    </div>
                `;
            }
        }

        function renderAnomalyWidget(anomalies) {
            const container = document.getElementById('anomalyWidget');
            if (!anomalies || anomalies.length === 0) {
                container.innerHTML = '<div class="bg-white/10 rounded-lg p-4"><span class="text-purple-100">No recent anomalies detected</span></div>';
                return;
            }

            const severityColors = {
                'critical': { badge: 'bg-red-600', bg: 'bg-red-50' },
                'high': { badge: 'bg-orange-600', bg: 'bg-orange-50' },
                'medium': { badge: 'bg-yellow-600', bg: 'bg-yellow-50' },
                'low': { badge: 'bg-blue-600', bg: 'bg-blue-50' }
            };

            let html = '';
            anomalies.forEach(anomaly => {
                const colors = severityColors[anomaly.severity] || severityColors.medium;

                html += `
                    <div class="${colors.bg} rounded-lg p-4 border border-gray-300">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="${colors.badge} text-white text-xs px-2 py-1 rounded-full font-semibold uppercase">
                                    ${anomaly.severity}
                                </span>
                                <span class="ml-2 text-xs text-gray-700">${anomaly.type.replace(/_/g, ' ')}</span>
                            </div>
                            <span class="text-xs text-gray-600">${new Date(anomaly.when).toLocaleString()}</span>
                        </div>
                        <h4 class="font-bold text-gray-900 mb-1">${anomaly.itemCode}</h4>
                        <p class="text-sm text-gray-700 mb-3">${anomaly.explanation}</p>
                        <div class="flex gap-2">
                            ${anomaly.suggestedActions.map(action => `
                                <button onclick="triageAnomaly('${anomaly.id}', '${action}', '${anomaly.severity}')"
                                        class="text-xs bg-white/80 hover:bg-white text-gray-900 font-semibold py-1 px-3 rounded-lg transition">
                                    ${action.replace(/_/g, ' ')}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        async function triageAnomaly(id, action, severity) {
            const actionLabels = {
                'open_spot_check': 'open a spot check',
                'freeze_reorder': 'freeze reorders for 7 days',
                'ignore_once': 'mark as reviewed',
                'notify_ops': 'notify operations team'
            };

            const confirmMessage = `Are you sure you want to ${actionLabels[action]} for anomaly ${id}?`;

            showConfirmModal(confirmMessage, async () => {
                try {
                    const result = await apiCall('/owner/ai/anomalies/triage', 'POST', { id, action });
                    showToast(`Anomaly triaged: ${result.result.message}`);
                    await loadAnomalyWidget(); // Refresh
                } catch (error) {
                    showToast('Failed to triage anomaly', 'error');
                }
            });
        }

        async function refreshAnomalyWidget() {
            await loadAnomalyWidget();
            showToast('Anomaly watchlist refreshed');
        }

        // === System Upgrade Advisor Widget ===
        async function loadAdvisorWidget() {
            const startTime = Date.now();
            try {
                const data = await apiCall('/owner/ai/upgrade/advice');
                upgradeAdvice = data.advice;
                renderAdvisorWidget(upgradeAdvice);
                const latency = (Date.now() - startTime) / 1000;
                console.log(`Advisor widget loaded in ${latency}s`);
            } catch (error) {
                console.error('Failed to load upgrade advice:', error);
                document.getElementById('advisorWidget').innerHTML = `
                    <div class="bg-red-500/20 rounded-lg p-4">
                        <span class="text-red-200">Failed to load system analysis</span>
                    </div>
                `;
            }
        }

        function renderAdvisorWidget(advice) {
            if (!advice) {
                document.getElementById('advisorWidget').innerHTML = '<div class="bg-white/10 rounded-lg p-4"><span class="text-purple-100">No advice available</span></div>';
                return;
            }

            const container = document.getElementById('advisorWidget');

            let html = `
                <div class="bg-white/10 rounded-lg p-4 space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-purple-100">Overall System Score</span>
                        <span class="text-2xl font-bold ${advice.overallScore > 0.8 ? 'text-green-300' : advice.overallScore > 0.6 ? 'text-yellow-300' : 'text-red-300'}">
                            ${(advice.overallScore * 100).toFixed(0)}%
                        </span>
                    </div>
                    <hr class="border-white/20">

                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-purple-100">Cache Hit Rate</span>
                            <span class="text-white font-semibold">${(advice.cache.hitRate * 100).toFixed(0)}%</span>
                        </div>
                        <p class="text-xs text-purple-200">${advice.cache.advice}</p>
                    </div>

                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-purple-100">Forecast Accuracy (MAPE-30)</span>
                            <span class="text-white font-semibold">${(advice.forecast.mape30 * 100).toFixed(1)}%</span>
                        </div>
                        <p class="text-xs text-purple-200">${advice.forecast.advice}</p>
                    </div>

                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-purple-100">Database</span>
                            <span class="text-white font-semibold uppercase">${advice.db.primary}</span>
                        </div>
                        <p class="text-xs text-purple-200">${advice.db.advice}</p>
                    </div>

                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-purple-100">2FA Adoption (Admins)</span>
                            <span class="text-white font-semibold">${advice.security.twoFAAdmins}</span>
                        </div>
                        <p class="text-xs text-purple-200">${advice.security.advice}</p>
                    </div>
                </div>
            `;

            if (advice.nextBestActions && advice.nextBestActions.length > 0) {
                html += `
                    <div class="bg-white/10 rounded-lg p-4 mt-3">
                        <h4 class="text-white font-semibold mb-2">Next Best Actions:</h4>
                        ${advice.nextBestActions.map((nba, idx) => `
                            <div class="text-sm ${idx > 0 ? 'mt-2' : ''}">
                                <div class="flex justify-between items-center">
                                    <span class="text-white font-semibold">${idx + 1}. ${nba.title}</span>
                                    <span class="text-xs px-2 py-1 ${nba.impact === 'high' ? 'bg-green-500' : 'bg-blue-500'} text-white rounded-full">
                                        ${nba.impact} impact
                                    </span>
                                </div>
                                <span class="text-xs text-purple-200">ETA: ${nba.etaMin} min</span>
                            </div>
                        `).join('')}
                    </div>
                `;

                document.getElementById('applyUpgradeBtn').disabled = false;
            } else {
                document.getElementById('applyUpgradeBtn').disabled = true;
            }

            container.innerHTML = html;
        }

        async function applyNextBestAction() {
            if (!upgradeAdvice || !upgradeAdvice.nextBestActions || upgradeAdvice.nextBestActions.length === 0) {
                showToast('No actions available to apply', 'error');
                return;
            }

            const nextAction = upgradeAdvice.nextBestActions[0];

            showConfirmModal(
                `Apply: ${nextAction.title}?\n\nImpact: ${nextAction.impact}\nETA: ${nextAction.etaMin} minutes`,
                async () => {
                    try {
                        const result = await apiCall('/owner/ai/upgrade/apply', 'POST', { actionId: nextAction.id });

                        if (result.result.status === 'requires-confirmation') {
                            showToast(`Action requires manual confirmation: ${result.result.message}`, 'error');
                        } else {
                            showToast(`Upgrade applied: ${result.result.message}`);
                        }

                        await loadAdvisorWidget(); // Refresh
                    } catch (error) {
                        showToast('Failed to apply upgrade action', 'error');
                    }
                }
            );
        }

        async function refreshAdvisorWidget() {
            await loadAdvisorWidget();
            showToast('System advisor refreshed');
        }

        // === Modal Management ===
        function showConfirmModal(message, onConfirm) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').classList.remove('hidden');

            document.getElementById('confirmBtn').onclick = async () => {
                closeConfirmModal();
                await onConfirm();
            };
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.add('hidden');
        }

        // === WebSocket Integration (Optional) ===
        let ws = null;

        function initializeWebSocket() {
            try {
                ws = new WebSocket('ws://localhost:8083/ai/realtime');

                ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);

                    switch (message.type) {
                        case 'forecast:update':
                            loadReorderWidget();
                            break;
                        case 'anomaly:alert':
                            showToast(`New anomaly detected: ${message.itemCode}`, 'warning');
                            loadAnomalyWidget();
                            break;
                        case 'system:metric_update':
                            loadAdvisorWidget();
                            break;
                    }
                };

                ws.onerror = () => console.log('WebSocket connection failed, using polling');
                ws.onclose = () => console.log('WebSocket disconnected');
            } catch (error) {
                console.log('WebSocket not available, using polling');
            }
        }

        // Initialize
        if (!token) {
            window.location.href = '/login.html';
        } else {
            loadDashboard();
            loadAIWidgets();

            // Auto-refresh base dashboard every 30 seconds
            autoRefreshInterval = setInterval(loadDashboard, 30000);

            // Auto-refresh AI widgets every 60 seconds
            setInterval(loadAIWidgets, 60000);

            // Initialize WebSocket
            initializeWebSocket();
        }
    </script>
</body>
</html>
